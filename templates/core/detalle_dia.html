{% extends 'base.html' %}

{% block title %}Detalle del {{ fecha|date:"d/m/Y" }} - Abarrotera Morelia{% endblock %}
{% load humanize %}

{% block extra_css %}
<style>
    /* Estilos para la sección de Tabulación */
.tabulacion-section {
    transition: all 0.3s ease;
    border: 1px solid var(--border-color);
}

.tabulacion-header {
    cursor: pointer;
    user-select: none;
}

.tabulacion-arrow {
    transition: transform 0.3s ease;
}

.tabulacion-arrow.expanded {
    transform: rotate(180deg);
}

.tabulacion-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.denominaciones-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 0.5rem;
}

.denominaciones-table th {
    text-align: left;
    color: var(--text-muted);
    font-size: 0.85rem;
    padding: 0.5rem;
}

.denominaciones-table td {
    padding: 0.25rem;
}

.denominacion-row {
    background: rgba(30, 41, 59, 0.3);
    border-radius: 8px;
    transition: background 0.2s ease;
}

.denominacion-row:hover {
    background: rgba(30, 41, 59, 0.6);
}

.denom-input {
    width: 100%;
    background: rgba(15, 23, 42, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.5rem;
    color: var(--text-light);
    font-family: inherit;
    text-align: right;
}

.denom-input:focus {
    outline: none;
    border-color: var(--accent-blue);
    background: rgba(15, 23, 42, 0.8);
}

.denom-label {
    font-weight: 600;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.denom-total {
    font-weight: 700;
    text-align: right;
    padding-right: 1rem;
    color: var(--text-light);
}

.tabulacion-resumen {
    background: rgba(15, 23, 42, 0.8);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid var(--border-color);
    height: fit-content;
}

.resumen-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
}

.resumen-row:last-child {
    border-bottom: none;
}

.resumen-label {
    color: var(--text-muted);
    font-size: 0.9rem;
}

.resumen-val {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-light);
}

.resumen-val.total {
    font-size: 1.5rem;
    color: var(--accent-blue);
}

.resumen-val.diff {
    font-weight: 700;
}

.diff-positive { color: #f59e0b; } /* Sobrante */
.diff-negative { color: #ef4444; } /* Faltante */
.diff-exact { color: #10b981; }    /* Exacto */

.btn-ticker {
    width: 100%;
    margin-top: 1.5rem;
    padding: 1rem;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.btn-ticker:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
}

.btn-ticker:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

    .error-message {
        color: #f87171;
        font-size: 0.85rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .success-message {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #bbf7d0;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .error-message {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #f87171;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .info-message {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: #93c5fd;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .day-detail-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 1.5rem;
    }

    .day-header {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
        text-align: center;
        position: relative;
    }

    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-light);
        text-decoration: none;
        font-weight: 600;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        position: absolute;
        left: 2rem;
        top: 2rem;
    }

    .back-btn:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: var(--accent-blue);
    }

    /* Botones de Navegación por Días */
    .day-navigation {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin: 2rem 0;
    }

    .nav-day-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid var(--border-color);
        color: var(--text-light);
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .nav-day-btn:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: var(--accent-blue);
        transform: scale(1.1);
    }

    .nav-day-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: rgba(30, 41, 59, 0.3);
    }

    .nav-day-btn:disabled:hover {
        transform: none;
        background: rgba(30, 41, 59, 0.3);
    }

    .current-date {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-light);
        min-width: 200px;
        text-align: center;
    }

    .day-title {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
    }

    .day-subtitle {
        color: var(--text-muted);
        font-size: 1.1rem;
        margin-bottom: 2rem;
    }

    /* Botón Movimientos - Azul */
.btn-movimientos {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: #ffffff;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 1rem;
}

.btn-movimientos:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(59, 130, 246, 0.35);
}

/* Botón Facturas - Amarillo */
.btn-facturas {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #3b82f6 0%, #facc15 100%);
    color: #ffffff;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 1rem;
}

.btn-facturas:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(250, 204, 21, 0.35);
}

/* Botón Ventas - Verde */
.btn-ventas {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
    color: #ffffff;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 1rem;
}

.btn-ventas:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
}


    /* Resumen del Día */
    .day-summary {
        background: rgba(30, 41, 59, 0.8);
        border-radius: 16px;
        padding: 2rem;
        margin: 2rem 0;
        border: 1px solid var(--border-color);
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }

    .summary-card {
        background: rgba(15, 23, 42, 0.5);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        text-align: center;
        transition: transform 0.3s ease;
    }

    .summary-card:hover {
        transform: translateY(-5px);
    }

    .summary-card.cargo {
        border-top: 4px solid var(--accent-red);
    }

    .summary-card.ventas {
        border-top: 4px solid var(--accent-green);
    }

    .summary-card.balance {
        border-top: 4px solid var(--accent-blue);
    }

    .summary-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
    }

    .icon-cargo {
        background: rgba(239, 68, 68, 0.1);
        color: #f87171;
    }

    .icon-ventas {
        background: rgba(16, 185, 129, 0.1);
        color: #4ade80;
    }

    .icon-balance {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
    }

    .summary-value {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #ffffff 0%, #cbd5e1 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .summary-label {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .summary-detail {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Alerta de Ventas Necesarias */
    .sales-alert {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 2rem 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .alert-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        background: rgba(245, 158, 11, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #f59e0b;
        flex-shrink: 0;
    }

    .alert-content {
        flex: 1;
    }

    .alert-title {
        font-weight: 600;
        color: var(--text-light);
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .alert-message {
        color: var(--text-muted);
        line-height: 1.5;
    }

    .alert-value {
        font-weight: 700;
        color: #f59e0b;
        font-size: 1.2rem;
    }

    /* Secciones de Detalle - AHORA EN COLUMNA */
    .detail-sections {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        margin-top: 2rem;
    }

    .detail-section {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        width: 100%;
    }

    /* TABLAS MÁS GRANDES */
    .wide-table {
        min-width: 100%;
        table-layout: auto;
    }
    
    .wide-table th {
        padding: 1.25rem 1rem;
        white-space: nowrap;
    }
    
    .wide-table td {
        padding: 1.25rem 1rem;
        min-width: 120px;
    }
    
    /* Ajustes para las tablas específicas */
    .facturas-table .proveedor-info {
        min-width: 250px;
    }
    
    .facturas-table td:first-child {
        min-width: 280px;
    }
    
    .ventas-table td:first-child {
        min-width: 200px;
    }

    .section-header {
        background: rgba(30, 41, 59, 0.95);
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .section-count {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .section-body {
        padding: 1.5rem;
        overflow-x: auto;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
    }

    .items-table th {
        text-align: left;
        padding: 1rem;
        color: var(--text-muted);
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
    }

    .items-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-light);
        vertical-align: top;
    }

    .items-table tr:hover {
        background: rgba(59, 130, 246, 0.05);
    }

    .items-table tr:last-child td {
        border-bottom: none;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }

    .status-pendiente {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .status-pagado {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-vencido {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status-abonado {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .amount-cell {
        font-weight: 600;
        font-size: 1.1rem;
        text-align: right;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Navegación rápida flotante */
    .quick-nav {
        position: fixed;
        right: 2rem;
        bottom: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        z-index: 100;
    }

    .quick-nav-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(30, 41, 59, 0.9);
        border: 1px solid var(--border-color);
        color: var(--text-light);
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .quick-nav-btn:hover {
        background: rgba(59, 130, 246, 0.2);
        border-color: var(--accent-blue);
        transform: scale(1.1);
    }

    /* Estilos para Proveedores y Acciones */
    .proveedor-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .proveedor-nombre {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-light);
    }
    
    .proveedor-datos {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.85rem;
        color: var(--text-muted);
    }
    
    .proveedor-dato {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .proveedor-dato i {
        width: 16px;
        text-align: center;
        color: var(--accent-blue);
    }
    
    .factura-notas {
        margin-top: 8px;
        padding: 8px;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 6px;
        font-size: 0.85rem;
        color: var(--text-muted);
        border-left: 3px solid var(--accent-purple);
    }
    
    .factura-notas i {
        margin-right: 6px;
        color: var(--accent-purple);
    }
    
    .acciones-factura {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }
    
    .btn-accion {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }
    
    .btn-editar {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
        border-color: rgba(59, 130, 246, 0.3);
    }
    
    .btn-editar:hover {
        background: rgba(59, 130, 246, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    
    .btn-pagar {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border-color: rgba(16, 185, 129, 0.3);
    }
    
    .btn-pagar:hover {
        background: rgba(16, 185, 129, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }

    .btn-eliminar {
        background: rgba(239, 68, 68, 0.1);
        color: var(--accent-red);
        border-color: rgba(239, 68, 68, 0.3);
    }
    
    .btn-eliminar:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }
    
    .tipo-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .tipo-factura {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
        border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .tipo-remision {
        background: rgba(139, 92, 246, 0.1);
        color: var(--accent-purple);
        border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .tipo-gastos_generales {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    /* Modal de confirmación para eliminar */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(5px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        border: 1px solid var(--border-color);
    }
    
    .modal-header {
        margin-bottom: 20px;
    }
    
    .modal-header h3 {
        color: var(--text-light);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .modal-body {
        margin-bottom: 25px;
        color: var(--text-light);
    }
    
    .modal-body p {
        margin-bottom: 10px;
    }
    
    .modal-body .text-muted {
        color: var(--text-muted);
        font-size: 0.9rem;
    }
    
    .modal-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
    }

    /* Estilos de botones del modal */
    .btn {
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        letter-spacing: 0.3px;
    }

    .btn-secondary {
        background: rgba(148, 163, 184, 0.1);
        color: #c0cbd8;
        border-color: rgba(148, 163, 184, 0.2);
    }

    .btn-secondary:hover {
        background: rgba(148, 163, 184, 0.2);
        color: #f1f5f9;
        transform: translateY(-1px);
    }

    .btn-danger {
        background: rgba(200, 50, 50, 0.15); 
        color: #fca5a5;
        border-color: rgba(220, 38, 38, 0.3);
    }

    .btn-danger:hover {
        background: rgba(220, 38, 38, 0.25);
        color: #fff;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
        transform: translateY(-1px);
    }
    
    @media (max-width: 768px) {
        .day-detail-container {
            padding: 0 1rem;
        }
        
        .back-btn {
            position: relative;
            left: 0;
            top: 0;
            margin-bottom: 1rem;
        }
        
        .day-title {
            font-size: 2rem;
        }
        
        .summary-grid {
            grid-template-columns: 1fr;
        }
        
        .day-navigation {
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .nav-day-btn {
            width: 45px;
            height: 45px;
            font-size: 1rem;
        }
        
        .quick-nav {
            right: 1rem;
            bottom: 1rem;
        }
        
        .quick-nav-btn {
            width: 45px;
            height: 45px;
            font-size: 1rem;
        }
        
        .acciones-factura {
            flex-direction: column;
            gap: 4px;
        }
        
        .btn-accion {
            width: 32px;
            height: 32px;
        }
        
        .section-body {
            padding: 1rem;
        }
        
        .wide-table th,
        .wide-table td {
            padding: 0.75rem 0.5rem;
            font-size: 0.85rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="day-detail-container">
    <!-- Header con Fecha -->
    <div class="day-header">
        <a href="{% url 'calendario-financiero' %}" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Volver al Calendario
        </a>
        
        <!-- Navegación por Días -->
        <div class="day-navigation">
            <a href="{% url 'detalle-dia' fecha_anterior|date:'Y-m-d' %}" class="nav-day-btn" title="Día anterior">
                <i class="fas fa-chevron-left"></i>
            </a>
            
            <div class="current-date">
                <h1 class="day-title">{{ fecha|date:"l, d F Y" }}</h1>
                <p class="day-subtitle">
                    {% if fecha == hoy %}
                        <i class="fas fa-calendar-day"></i> Hoy
                    {% elif fecha > hoy %}
                        <i class="fas fa-calendar-plus"></i> {{ fecha|timeuntil:hoy }} en el futuro
                    {% else %}
                        <i class="fas fa-calendar-minus"></i> {{ fecha|timesince:hoy }} atrás
                    {% endif %}
                </p>
            </div>
            
            <a href="{% url 'detalle-dia' fecha_siguiente|date:'Y-m-d' %}" class="nav-day-btn" title="Día siguiente">
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>
        
        <!-- Botones de Acción -->
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
            <button class="btn-movimientos" onclick="location.href='{% url 'lista-movimientos' %}'">
                <i class="fas fa-exchange-alt"></i>
                Movimientos
            </button>
            <button class="btn-facturas" onclick="location.href='{% url 'crear-factura' fecha|date:'Y-m-d' %}'">
                <i class="fa-solid fa-file-invoice"></i>
                Nueva Factura
            </button>
            <button class="btn-ventas" onclick="location.href='{% url 'crear-venta' fecha|date:'Y-m-d' %}'">
                <i class="fa-solid fa-file-invoice"></i>
                Nueva Venta
            </button>
        </div>
    </div>


    <!-- Opciones de Pago Masivo -->
    {% if fechas_pago_dia %}
    <div style="margin-bottom: 2rem; display: flex; justify-content: flex-end;">
        <form method="POST" action="{% url 'pagar-facturas-masivas' %}" onsubmit="return confirm('¿Estás seguro de pagar TODAS las facturas de este día? Se generarán los movimientos correspondientes.');">
            {% csrf_token %}
            <!-- Pasamos solo los IDs de las fechas de pago -->
            <input type="hidden" name="fechas_ids" value="{% for fp in fechas_pago_dia %}{{ fp.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
            <input type="hidden" name="fecha_pago" value="{{ fecha|date:'Y-m-d' }}">
            <button type="submit" class="btn-pagar" style="padding: 1rem 2rem; border-radius: 12px; border:none; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 0.5rem; color: #10b981; background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3);">
                <i class="fas fa-check-double"></i> Pagar Todo ({{ fechas_pago_dia.count }})
            </button>
        </form>
    </div>
    {% endif %}

    <!-- Resumen del Día -->

    <div class="day-summary">
        <h2 style="color: var(--text-light); margin-bottom: 1.5rem; font-size: 1.5rem;">
            <i class="fas fa-chart-bar"></i> Resumen Financiero del Día
        </h2>
        
        <div class="summary-grid">
            <!-- Cargo Total -->
            <div class="summary-card cargo">
                <div class="summary-icon icon-cargo">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="summary-value">${{ cargo_total_dia|floatformat:2|intcomma }}</div>
                <div class="summary-label">Cargo Total del Día</div>
                <div class="summary-detail">
                    {{ fechas_pago_dia.count }} fecha{{ fechas_pago_dia.count|pluralize }}
                </div>
            </div>
            
            <!-- Venta Total -->
            <div class="summary-card ventas">
                <div class="summary-icon icon-ventas">
                    <i class="fas fa-cash-register"></i>
                </div>
                <div class="summary-value">${{ venta_total_dia|floatformat:2|intcomma }}</div>
                <div class="summary-label">Venta Total del Día</div>
                <div class="summary-detail">
                    {{ ventas.count }} venta{{ ventas.count|pluralize }}
                </div>
            </div>
            
            <!-- Balance -->
            <div class="summary-card balance">
                <div class="summary-icon icon-balance">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div class="summary-value">${{ total_pago_del_dia|floatformat:2|intcomma }}</div>
                <div class="summary-label">Pagos del Día</div>
                <div class="summary-detail">
                    {% with total=cantidad_pagos_del_dia %}
                    {{ total }} pago{{ total|pluralize }}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- Alerta de Ventas Necesarias (solo para fechas futuras) -->
    {% if es_futuro and cargo_total_dia > 0 %}
    <div class="sales-alert">
        <div class="alert-icon">
            <i class="fas fa-calculator"></i>
        </div>
        <div class="alert-content">
            <div class="alert-title">Planificación de Ventas Necesarias</div>
            <div class="alert-message">
                Para pagar las fechas de pago de este día <strong>({{ fecha|date:"d/m/Y" }})</strong>, 
                necesitas vender en promedio 
                <span class="alert-value">${{ promedio_ventas_diarias|floatformat:2|intcomma }} por día</span> 
                durante los <strong>{{ dias_restantes }} día{{ dias_restantes|pluralize }}</strong> 
                restantes.
                <br>
                <small style="opacity: 0.8;">
                    Cálculo: ${{ cargo_total_dia|floatformat:2|intcomma }} ÷ {{ dias_restantes }} días = ${{ promedio_ventas_diarias|floatformat:2|intcomma }}/día
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Sección de Tabulación (Nueva) -->
    <div class="detail-sections" style="margin-bottom: 0;">
        <div class="detail-section tabulacion-section" id="tabulacionSection">
            <div class="section-header tabulacion-header" onclick="toggleTabulation()">
                <div class="section-title">
                    <i class="fas fa-calculator" style="color: #60a5fa;"></i>
                    Tabulación de Efectivo
                </div>
                <i class="fas fa-chevron-down tabulacion-arrow" id="tabArrow"></i>
            </div>
            
            <div class="section-body" id="tabBody" style="display: none;">
                <div class="tabulacion-grid">
                    <!-- Tabla de Denominaciones -->
                    <div class="denominaciones-container">
                        <table class="denominaciones-table">
                            <thead>
                                <tr>
                                    <th width="35%">Denominación</th>
                                    <th width="30%">Cantidad</th>
                                    <th width="25%" style="text-align: right;">Total</th>
                                    <th width="10%"></th>
                                </tr>
                            </thead>
                            <tbody id="denominacionesBody">
                                <!-- Filas generadas por JS -->
                            </tbody>
                        </table>
                        
                        <button type="button" class="btn-add-row" onclick="addRow()" style="margin-top: 1rem; width: 100%; padding: 0.75rem; background: rgba(30, 41, 59, 0.5); border: 1px dashed var(--border-color); color: var(--text-muted); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-plus"></i> Agregar Denominación
                        </button>
                    </div>

                    <!-- Resumen y Acciones -->
                    <div class="tabulacion-resumen">
                        <h3 style="color: var(--text-light); margin-bottom: 1.5rem;">Resumen de Caja</h3>
                        
                        <div class="resumen-row">
                            <span class="resumen-label">Total en Facturas (Hoy)</span>
                            <span class="resumen-val" id="targetTotal">${{ cargo_total_tabulacion|floatformat:2|intcomma }}</span>
                        </div>
                        
                        <div class="resumen-row">
                            <span class="resumen-label">Total Tabulación</span>
                            <span class="resumen-val total" id="tabTotal">$0.00</span>
                        </div>
                        
                        <div class="resumen-row" style="border-top: 2px solid var(--border-color); margin-top: 1rem; padding-top: 1rem;">
                            <span class="resumen-label">Diferencia</span>
                            <span class="resumen-val diff" id="diffTotal">$0.00</span>
                        </div>

                        <button class="btn-ticker" id="btnGenerarTicker" onclick="generarTicker()">
                            <i class="fas fa-file-invoice"></i>
                            Generar Ticker PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secciones de Detalle - AHORA EN COLUMNA -->
    <div class="detail-sections">
        <!-- Sección de Fechas de Pago (MÁS GRANDE) -->
        <div class="detail-section facturas-table">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-calendar-alt" style="color: #a78bfa;"></i>
                    Facturas Por Pagar del Día
                </div>
                <div class="section-count">
                    {{ fechas_pago_dia.count }}
                </div>
            </div>
            
            <div class="section-body">
                {% if fechas_pago_dia %}
                    <table class="items-table wide-table">
                        <thead>
                            <tr>
                                <th>Proveedor</th>
                                <th>Folio Factura</th>
                                <th>Estado Factura</th>
                                <th>Monto Restante</th>
                                <th>Monto Definido Para Pagar Hoy</th>
                                <th>Monto Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for fecha_pago in fechas_pago_dia %}
                            <tr>
                                <td>
                                    <div class="proveedor-info">
                                        <div class="proveedor-nombre">{{ fecha_pago.factura.proveedor.nombre }}</div>
                                        <div class="proveedor-datos">
                                            <div class="proveedor-dato">
                                                 <i class="fas fa-id-card"></i>
                                                 <span>
                                                     {% with cuenta_info=fecha_pago.factura.cuenta_a_mostrar %}
                                                         {{ cuenta_info.0 }}
                                                         {% if cuenta_info.1 %}
                                                             <span style="color: var(--text-muted); font-size: 0.8em;">({{ cuenta_info.1 }})</span>
                                                         {% endif %}
                                                     {% endwith %}
                                                     {% if fecha_pago.factura.cuenta_override != 'AUTO' %}
                                                         <span style="
                                                             background: rgba(251,191,36,0.15);
                                                             border: 1px solid rgba(251,191,36,0.35);
                                                             color: #fbbf24;
                                                             font-size: 0.7em;
                                                             padding: 1px 6px;
                                                             border-radius: 4px;
                                                             margin-left: 4px;
                                                             vertical-align: middle;
                                                         " title="Cuenta seleccionada manualmente">
                                                             <i class="fas fa-hand-pointer" style="font-size:0.85em;"></i> Manual
                                                         </span>
                                                     {% endif %}
                                                 </span>

                                            </div>
                                            {% if fecha_pago.factura.proveedor.telefono %}
                                            <div class="proveedor-dato">
                                                <i class="fas fa-phone"></i>
                                                <span>{{ fecha_pago.factura.proveedor.telefono }}</span>
                                            </div>
                                            {% endif %}
                                            {% if fecha_pago.factura.proveedor.email %}
                                            <div class="proveedor-dato">
                                                <i class="fas fa-envelope"></i>
                                                <span>{{ fecha_pago.factura.proveedor.email }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% if fecha_pago.factura.notas %}
                                        <div class="factura-notas">
                                            <i class="fas fa-sticky-note"></i>
                                            {{ fecha_pago.factura.notas|truncatechars:60 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if fecha_pago.factura.folio %}
                                        <strong>{{ fecha_pago.factura.folio }}</strong>
                                    {% else %}
                                        <span style="color: var(--text-muted); font-style: italic;">Sin folio</span>
                                    {% endif %}
                                    <div style="margin-top: 4px;">
                                        <span class="tipo-badge tipo-{{ fecha_pago.factura.tipo|lower }}">
                                            {{ fecha_pago.factura.get_tipo_display }}
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ fecha_pago.factura.estado|lower }}">
                                        {{ fecha_pago.factura.get_estado_display }}
                                    </span>
                                </td>
                                <td class="amount-cell">
                                    ${{ fecha_pago.monto_restante|floatformat:2|intcomma }}
                                </td>
                                <td class="amount-cell">
                                    ${{ fecha_pago.monto_por_pagar|floatformat:2|intcomma }}
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                                        <i class="fas fa-calendar-day"></i> {{ fecha_pago.fecha_por_pagar|date:"d/m/Y" }}
                                    </div>
                                </td>
                                <td class="amount-cell">
                                    ${{ fecha_pago.factura.monto|floatformat:2|intcomma }}
                                </td>
                                <td>
                                    <div class="acciones-factura">
                                        <!-- Botón Editar Factura -->
                                        <a href="{% url 'pagar-factura' fecha_pago.factura.pk fecha|date:'Y-m-d' %}" class="btn-accion btn-pagar" title="Pagar factura">
                                            <i class="fa-regular fa-money-bill-1"></i>
                                        </a>
                                        <a href="{% url 'editar-factura' fecha_pago.factura.pk fecha|date:'Y-m-d' %}" class="btn-accion btn-editar" title="Editar factura">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button onclick="mostrarModalEliminar({{ fecha_pago.factura.pk }}, '{{ fecha_pago.factura.proveedor.nombre|escapejs }}', '{{ fecha_pago.factura.folio|escapejs }}')" class="btn-accion btn-eliminar" title="Eliminar factura" style="border:none; cursor:pointer;">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr style="background: rgba(30, 41, 59, 0.5); font-weight: 600;">
                                <td colspan="3">Totales del Día</td>
                                <td class="amount-cell">${{ cargo_restante_total_dia|floatformat:2|intcomma }}</td>
                                <td class="amount-cell">${{ cargo_total_dia|floatformat:2|intcomma }}</td>
                                <td class="amount-cell">${{ monto_total_facturas_dia|floatformat:2|intcomma }}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>No hay fechas de pago para este día</h3>
                        <p>Todas las obligaciones están al día</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Sección de Ventas del Día (MÁS GRANDE) -->
        <div class="detail-section ventas-table">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-store" style="color: #4ade80;"></i>
                    Ventas del Día
                </div>
                <div class="section-count">
                    {{ ventas.count }}
                </div>
            </div>
            
            <div class="section-body">
                {% if ventas %}
                    <table class="items-table wide-table">
                        <thead>
                            <tr>
                                <th>Sucursal</th>
                                <th>Monto</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venta in ventas %}
                            <tr>
                                <td style="font-weight: 600;">{{ venta.sucursal.nombre }}</td>
                                <td class="amount-cell">${{ venta.monto|floatformat:2|intcomma }}</td>
                                <td>
                                    <div class="acciones-factura">
                                        <!-- Botón Editar Venta -->
                                        <a href="{% url 'editar-venta' venta.pk fecha|date:'Y-m-d' %}" class="btn-accion btn-editar" title="Editar venta">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <!-- Botón Eliminar Venta -->
                                        <form method="post" 
                                              action="{% url 'eliminar-venta' venta.pk fecha|date:'Y-m-d' %}" 
                                              style="display: inline;"
                                              onsubmit="return confirm('¿Estás seguro de eliminar esta venta de {{ venta.sucursal.nombre }} por ${{ venta.monto|floatformat:2 }}?');">
                                            {% csrf_token %}
                                            <button type="submit" 
                                                    class="btn-accion btn-eliminar" 
                                                    title="Eliminar venta"
                                                    style="border: none; cursor: pointer;">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr style="background: rgba(30, 41, 59, 0.5); font-weight: 600;">
                                <td>Total General</td>
                                <td class="amount-cell">${{ venta_total_dia|floatformat:2|intcomma }}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-store-slash"></i>
                        <h3>No hay ventas registradas</h3>
                        <p>No se realizaron ventas en este día</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-exclamation-triangle"></i>
                    Confirmar Eliminación
                </h3>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar la factura de <strong id="proveedorNombre"></strong>?</p>
                <p>Folio: <strong id="facturaFolio"></strong></p>
                <p class="text-muted">Esta acción no se puede deshacer y afectará los movimientos contables relacionados.</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelDelete">
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    Eliminar
                </button>
                <form id="deleteForm" method="POST" style="display:none;">
                    {% csrf_token %}
                </form>
            </div>
        </div>
    </div>

    <!-- Navegación rápida flotante -->
    <div class="quick-nav">
        <a href="{% url 'detalle-dia' fecha_anterior|date:'Y-m-d' %}" class="quick-nav-btn" title="Día anterior (←)">
            <i class="fas fa-chevron-left"></i>
        </a>
        <a href="{% url 'detalle-dia' hoy|date:'Y-m-d' %}" class="quick-nav-btn" title="Ir a hoy (H)">
            <i class="fas fa-calendar-day"></i>
        </a>
        <a href="{% url 'detalle-dia' fecha_siguiente|date:'Y-m-d' %}" class="quick-nav-btn" title="Día siguiente (→)">
            <i class="fas fa-chevron-right"></i>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animación para las tarjetas de resumen
        const summaryCards = document.querySelectorAll('.summary-card');
        summaryCards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 200);
        });

        // Efecto hover para las filas de la tabla
        const tableRows = document.querySelectorAll('.items-table tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'rgba(59, 130, 246, 0.05)';
            });
            
            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });



        // Función para calcular ventas necesarias
        function calcularVentasNecesarias() {
            {% if es_futuro and cargo_total_dia > 0 %}
            const cargoTotal = {{ cargo_total_dia }};
            const diasRestantes = {{ dias_restantes }};
            
            if (diasRestantes > 0) {
                const promedioDiario = cargoTotal / diasRestantes;
                
                // Crear una alerta más detallada
                const alerta = `
                    <div style="padding: 1rem; background: rgba(15, 23, 42, 0.9); border-radius: 10px; margin-top: 1rem;">
                        <h4 style="color: #f59e0b; margin-bottom: 0.5rem;">
                            <i class="fas fa-calculator"></i> Planificación de Fechas de Pago
                        </h4>
                        <p style="margin-bottom: 0.5rem;">
                            <strong>Fechas de pago por cubrir:</strong> $${cargoTotal.toFixed(2)}<br>
                            <strong>Días restantes:</strong> ${diasRestantes} días<br>
                            <strong>Ventas diarias necesarias:</strong> $${promedioDiario.toFixed(2)}<br>
                            <strong>Meta total de ventas:</strong> $${(promedioDiario * diasRestantes).toFixed(2)}
                        </p>
                        <small style="color: #94a3b8;">
                            Esta estimación considera todas las fechas de pago programadas para este día.
                        </small>
                    </div>
                `;
                
                console.log('Ventas necesarias calculadas:', promedioDiario);
            }
            {% endif %}
        }

        // Función para mostrar el modal de eliminación
        window.mostrarModalEliminar = function(facturaId, proveedorNombre, facturaFolio) {
            const modal = document.getElementById('confirmModal');
            const proveedorElement = document.getElementById('proveedorNombre');
            const folioElement = document.getElementById('facturaFolio');
            const deleteForm = document.getElementById('deleteForm');
            
            // Configurar los datos en el modal
            proveedorElement.textContent = proveedorNombre;
            folioElement.textContent = facturaFolio;
            
            // Configurar la acción del formulario
            const urlTemplate = "{% url 'eliminar-factura' 0 fecha|date:'Y-m-d' %}";
            deleteForm.action = urlTemplate.replace('0', facturaId);
            
            // Mostrar el modal
            modal.style.display = 'flex';
            
            // Configurar botón de cancelar
            document.getElementById('cancelDelete').addEventListener('click', function() {
                modal.style.display = 'none';
            });

             // Configurar botón de confirmar (submit form)
            document.getElementById('confirmDelete').onclick = function() {
                 deleteForm.submit();
            };
            
            // Cerrar modal al hacer clic fuera del contenido
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('confirmModal');
                if (modal.style.display === 'flex') {
                    modal.style.display = 'none';
                }
            }
        });

        // Ejecutar cálculo al cargar
        calcularVentasNecesarias();
        
        // TABULACIÓN LOGIC
        const denomBody = document.getElementById('denominacionesBody');
        const tabTotalEl = document.getElementById('tabTotal');
        const diffTotalEl = document.getElementById('diffTotal');
        const targetTotalString = "{{ cargo_total_tabulacion|default:cargo_total_dia|stringformat:'f' }}"; // Get raw float string (excluding Mercado Pago)
        const targetTotal = parseFloat(targetTotalString) || 0;

        // Toggle UI
        window.toggleTabulation = function() {
            const body = document.getElementById('tabBody');
            const arrow = document.getElementById('tabArrow');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                arrow.classList.add('expanded');
                // Inicializar con una fila vacía si no hay nada
                if (denomBody.children.length === 0) {
                    addRow();
                }
            } else {
                body.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        };

        window.addRow = function(denomVal = '', countVal = '') {
            const tr = document.createElement('tr');
            tr.className = 'denominacion-row';
            const id = Date.now() + Math.random(); 
            
            tr.innerHTML = `
                <td>
                    <div class="denom-label">
                        <span style="color: #94a3b8; margin-right: 4px;">$</span>
                        <input type="number" 
                               class="denom-input value-input" 
                               value="${denomVal}"
                               min="0" 
                               step="0.1"
                               placeholder="0.00"
                               style="text-align: left;"
                               oninput="calcRow(this)">
                    </div>
                </td>
                <td>
                    <input type="number" 
                           class="denom-input count-input" 
                           value="${countVal}"
                           min="0" 
                           placeholder="0"
                           oninput="calcRow(this)">
                </td>
                <td>
                    <div class="denom-total" id="total-${id}">$0.00</div>
                </td>
                <td>
                    <button onclick="removeRow(this)" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            denomBody.appendChild(tr);
            
            // Foco en el nuevo input de denominación si se agregó manualmente
            if (denomVal === '') {
                setTimeout(() => tr.querySelector('.value-input').focus(), 50);
            }
        };

        window.removeRow = function(btn) {
            btn.closest('tr').remove();
            calcGrandTotal();
        };
        
        // Calcular fila
        window.calcRow = function(input) {
            const row = input.closest('tr');
            const denomInput = row.querySelector('.value-input');
            const countInput = row.querySelector('.count-input');
            const totalEl = row.querySelector('.denom-total');
            
            const denom = parseFloat(denomInput.value) || 0;
            const count = parseFloat(countInput.value) || 0;
            
            // Validar negativos
            if (denom < 0) denomInput.value = 0;
            if (count < 0) countInput.value = 0;

            const total = denom * count;

            // Update row total
            totalEl.textContent = `$${total.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            totalEl.dataset.value = total;

            calcGrandTotal();
        };

        function calcGrandTotal() {
            let total = 0;
            const totals = document.querySelectorAll('.denom-total');
            totals.forEach(el => {
                total += parseFloat(el.dataset.value) || 0;
            });

            // Update Grand Total
            tabTotalEl.textContent = `$${total.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            
            // Update Diff
            const diff = total - targetTotal;
            const diffFormatted = `$${Math.abs(diff).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            
            if (Math.abs(diff) < 0.01) {
                diffTotalEl.innerHTML = `<i class="fas fa-check-circle"></i> Exacto`;
                diffTotalEl.className = 'resumen-val diff diff-exact';
            } else if (diff > 0) {
                diffTotalEl.innerHTML = `<i class="fas fa-plus-circle"></i> ${diffFormatted} (Sobrante)`;
                diffTotalEl.className = 'resumen-val diff diff-positive';
            } else {
                diffTotalEl.innerHTML = `<i class="fas fa-minus-circle"></i> -${diffFormatted} (Faltante)`;
                diffTotalEl.className = 'resumen-val diff diff-negative';
            }
        }

        // Generar Ticker PDF
        window.generarTicker = function() {
            const rows = [];
            const trs = document.querySelectorAll('.denominacion-row');
            
            trs.forEach(tr => {
                const denomInput = tr.querySelector('.value-input');
                const countInput = tr.querySelector('.count-input');
                
                const denom = parseFloat(denomInput.value) || 0;
                const count = parseFloat(countInput.value) || 0;
                
                if (denom > 0 && count > 0) {
                    rows.push({
                        denom: denom,
                        cantidad: count,
                        total: denom * count
                    });
                }
            });
            
            const totalTabulacion = rows.reduce((acc, curr) => acc + curr.total, 0);
            
            const data = {
                fecha: "{{ fecha|date:'Y-m-d' }}",
                cargo_total: targetTotal,
                tabulacion_total: totalTabulacion,
                diferencia: totalTabulacion - targetTotal,
                filas: rows
            };
            
            const btn = document.getElementById('btnGenerarTicker');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
            btn.disabled = true;

            // Enviar al backend
            fetch("{% url 'exportar_tabulacion' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Error al generar PDF');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Ticker_${data.fecha}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('No se pudo generar el ticker. Intente nuevamente.');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        };


    });
</script>
{% endblock %}